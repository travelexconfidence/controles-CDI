<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>Comparador TED + Tarifas (PDF ⇄ Excel)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<!-- XLSX -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background:#f5f5f5;
}
h2 { margin-top: 30px; }

.box {
    background: white;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 25px;
    box-shadow: 0 0 8px rgba(0,0,0,0.15);
}

button {
    padding: 10px 16px;
    border: none;
    background: #0077cc;
    color: white;
    border-radius: 6px;
    cursor: pointer;
}
button:hover { background: #005fa3; }

.status {
    margin-top: 8px;
    font-weight: bold;
    color: green;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}
table th, table td {
    padding: 8px;
    border: 1px solid #ccc;
}
table th { background: #eee; }
</style>

</head>
<body>

<h1>Comparador TED + Tarifas (PDF ⇄ Excel)</h1>

<div class="box">
    <h2>1️⃣ Carregar PDF da Movimentação</h2>
    <button onclick="document.getElementById('pdfInput').click()">Carregar PDF</button>
    <input type="file" id="pdfInput" accept="application/pdf" style="display:none">

    <div id="pdfStatus"></div>
</div>

<div class="box">
    <h2>2️⃣ Carregar Excel para Conciliação</h2>
    <button onclick="document.getElementById('excelInput').click()">Carregar Excel</button>
    <input type="file" id="excelInput" accept=".xlsx,.xls" style="display:none">

    <div id="excelStatus"></div>
</div>

<div class="box">
    <h2>3️⃣ Resultado da Conciliação</h2>
    <button onclick="comparar()">Comparar PDF ⇄ Excel</button>

    <div id="resultado"></div>
</div>

<script>
let pdfValores = [];
let excelValores = [];

/* -------------------- CARREGAR PDF -------------------- */
document.getElementById("pdfInput").addEventListener("change", async (ev) => {
    const file = ev.target.files[0];
    if (!file) return;

    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;

    pdfValores = [];

    for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const text = await page.getTextContent();

        const linhas = text.items.map(t => t.str);

        linhas.forEach(l => {
            const m = l.match(/(\d{2}\/\d{2}\/\d{4}).*?(-?\d+,\d{2})/);
            if (m) {
                pdfValores.push({
                    data: m[1],
                    valor: parseFloat(m[2].replace(".", "").replace(",", "."))
                });
            }
        });
    }

    document.getElementById("pdfStatus").innerHTML = `<div class="status">PDF carregado ✔ (${pdfValores.length} registros)</div>`;
});

/* -------------------- CARREGAR EXCEL -------------------- */
document.getElementById("excelInput").addEventListener("change", async (ev) => {
    const file = ev.target.files[0];
    if (!file) return;

    const data = await file.arrayBuffer();
    const workbook = XLSX.read(data);
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet);

    excelValores = [];

    json.forEach(l => {
        const valor = parseFloat(String(l.Valor || l.VALOR || l.valor).replace(".", "").replace(",", "."));

        if (!isNaN(valor)) {
            excelValores.push({
                data: l.Data || l.DATA || l.data,
                valor: valor
            });
        }
    });

    document.getElementById("excelStatus").innerHTML = `<div class="status">Excel carregado ✔ (${excelValores.length} registros)</div>`;
});

/* -------------------- COMPARAR -------------------- */
function comparar() {
    if (pdfValores.length === 0 || excelValores.length === 0) {
        alert("Carregue o PDF e o Excel antes!");
        return;
    }

    const achados = [];
    const naoAchados = [];

    pdfValores.forEach(p => {
        const encontrado = excelValores.find(e =>
            Math.abs(e.valor - p.valor) < 0.001
        );

        if (encontrado) achados.push({ pdf: p, excel: encontrado });
        else naoAchados.push(p);
    });

    let html = "<h3>Registros Encontrados</h3>";
    html += gerarTabelaAchados(achados);

    html += "<h3>Não Encontrados no Excel</h3>";
    html += gerarTabelaNaoAchados(naoAchados);

    document.getElementById("resultado").innerHTML = html;
}

/* -------------------- TABELAS -------------------- */
function gerarTabelaAchados(lista) {
    if (lista.length === 0) return "<p>Nenhum encontrado.</p>";

    let t = "<table><tr><th>Data PDF</th><th>Valor PDF</th><th>Data Excel</th><th>Valor Excel</th></tr>";

    lista.forEach(l => {
        t += `<tr>
                <td>${l.pdf.data}</td>
                <td>${l.pdf.valor.toFixed(2)}</td>
                <td>${l.excel.data}</td>
                <td>${l.excel.valor.toFixed(2)}</td>
              </tr>`;
    });

    return t + "</table>";
}

function gerarTabelaNaoAchados(lista) {
    if (lista.length === 0) return "<p>Todos encontrados no Excel ✔</p>";

    let t = "<table><tr><th>Data</th><th>Valor</th></tr>";

    lista.forEach(l => {
        t += `<tr><td>${l.data}</td><td>${l.valor.toFixed(2)}</td></tr>`;
    });

    return t + "</table>";
}
</script>

</body>
</html>
