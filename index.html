<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Ganhos CDI</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #0A0A33;
            --primary-light: #1A1A55;
            --secondary: #C00000;
            --secondary-light: #E00000;
            --background: #f4f4f9;
            --card-bg: #ffffff;
            --text-color: #333;
            --ganho-color: #008000;
            --perda-color: #CC0000;
            --border-color: #ddd;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: var(--background);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        header {
            background: var(--primary);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            margin: 0;
            font-size: 1.8em;
            display: flex;
            align-items: center;
        }

        #siteLogo {
            height: 40px;
            max-width: 150px;
            margin-right: 15px;
            display: none;
        }

        main {
            padding: 20px;
            flex-grow: 1;
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
        }

        .card-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border-left: 5px solid var(--primary);
        }

        .card.total-compromissada { border-left-color: var(--primary); }
        .card.total-retorno { border-left-color: #007BFF; }
        .card.total-cdi { border-left-color: var(--ganho-color); }

        .card h3 {
            margin-top: 0;
            color: var(--text-color);
            font-size: 1em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card p {
            font-size: 2em;
            font-weight: 700;
            margin: 5px 0 0;
            color: var(--primary);
        }

        .card.total-cdi p { color: var(--ganho-color); }

        /* Estilos de Formul√°rio e Controles */
        .controls, .manual-entry, .filter-controls {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            border-top: 3px solid var(--secondary);
        }

        .controls h2, .manual-entry h2, .filter-controls h2 {
            color: var(--primary);
            margin-top: 0;
            font-size: 1.5em;
            border-bottom: 1px dashed var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .input-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .input-item {
            display: flex;
            flex-direction: column;
            min-width: 150px;
            flex-grow: 1;
        }

        .input-item label {
            font-size: 0.9em;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-color);
        }

        .input-item input, .input-item select {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1em;
            box-sizing: border-box;
            background: #fafafa;
        }

        .btn-container {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s, opacity 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            min-width: 120px;
            justify-content: center;
        }

        /* Bot√µes Prim√°rios */
        .btn:not(.secondary):not(.danger) {
            background: var(--primary);
            color: white;
            border: 1px solid white;
        }
        .btn:not(.secondary):not(.danger):hover { background: var(--primary-light); }

        /* Bot√µes Secund√°rios/Perigo */
        .btn.secondary, .btn.danger {
            background: var(--secondary);
            color: white;
            border: 1px solid white;
        }
        .btn.secondary:hover, .btn.danger:hover { background: var(--secondary-light); }

        .btn.small {
            padding: 5px 10px;
            font-size: 0.8em;
            min-width: 80px;
        }

        /* √Årea de Log */
        #log {
            margin-top: 10px;
            padding: 10px;
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
            border-radius: 4px;
            font-size: 0.9em;
            white-space: pre-wrap;
        }

        /* Estilos da Tabela */
        .table-section {
            margin-top: 30px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            overflow: hidden;
        }

        table th, table td {
            padding: 12px 15px;
            text-align: right;
            border-bottom: 1px solid var(--border-color);
        }

        table th {
            background: var(--primary);
            color: white;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        table tbody tr:hover { background: #f0f0f0; }

        .col-data { text-align: center; white-space: nowrap; }
        .col-left { text-align: left; max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        .ganho { color: var(--ganho-color); font-weight: 700; }
        .perda { color: var(--perda-color); font-weight: 700; }

        .action-cell { text-align: center; white-space: nowrap; }
        .action-cell .btn { margin: 2px; }

        .individual-operation-row td {
            background: rgba(255, 255, 255, 0.9);
            font-size: 0.9em;
        }
        
        /* Ocultar input file real */
        #logoFile, #excelFile {
            display: none;
        }

        .logo-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Estilos de Impress√£o */
        @media print {
            header, .controls, .manual-entry, #log, .action-cell, .btn-container {
                display: none;
            }
            body { background: white; color: black; }
            main { padding: 0; }
            .card-container, table { box-shadow: none; }
            .card p { color: var(--text-color); }
            .card.total-cdi p { color: var(--ganho-color); }
            table th { background: #eee; color: black; border-color: #999; }
            table td { border-color: #999; }
        }
    </style>
</head>

<body onload="loadState()">

    <header>
        <h1>
            <img id="siteLogo" alt="Logo" style="display: none;">
            Controle de Ganhos CDI
        </h1>
        <div class="logo-controls">
            <input type="file" id="logoFile" accept="image/*">
            <button id="addLogoBtn" class="btn small">‚öôÔ∏è Adicionar Logo</button>
            <button id="removeLogoBtn" class="btn small danger">üóëÔ∏è Remover Logo</button>
        </div>
    </header>

    <main>
        <div class="card-container">
            <div class="card total-compromissada" id="totalCompromissadaDisplay">
                <h3>Total Aplicado (Compromissada)</h3>
                <p>R$ 0,00</p>
            </div>
            <div class="card total-retorno" id="totalRetornoDisplay">
                <h3>Total Retorno Bruto</h3>
                <p>R$ 0,00</p>
            </div>
            <div class="card total-cdi" id="totalCdiDisplay">
                <h3>Ganho (CDI Total)</h3>
                <p>R$ 0,00</p>
            </div>
        </div>

        <div id="log">Aguardando carregamento de dados do Firestore...</div>
        
        <hr>

        <div class="controls">
            <h2>‚öôÔ∏è Configura√ß√µes Globais</h2>
            <div class="input-group">
                <div class="input-item">
                    <label for="taxaCdiAnual">Taxa CDI Anual Padr√£o (%)</label>
                    <input type="text" id="taxaCdiAnual" value="14,90" placeholder="Ex: 14,90" onchange="calculateAndRender()">
                </div>
                <div class="input-item">
                    <label for="diasAno">Dias √öteis no Ano Padr√£o</label>
                    <input type="number" id="diasAno" value="252" placeholder="Ex: 252" onchange="calculateAndRender()">
                </div>
            </div>
            <div class="btn-container">
                <button id="saveGlobalBtn" class="btn" onclick="saveState()">üíæ Salvar Configura√ß√µes e Dados</button>
            </div>
        </div>

        <hr>

        <div class="manual-entry">
            <h2>‚úçÔ∏è Lan√ßamento Manual / Edi√ß√£o</h2>
            <input type="hidden" id="editIndex" value="-1">
            <div class="input-group">
                <div class="input-item" style="min-width: 100px;">
                    <label for="manualData">Data (AAAA-MM-DD)</label>
                    <input type="date" id="manualData">
                </div>
                <div class="input-item">
                    <label for="manualDesc">Descri√ß√£o / Resumo da Opera√ß√£o</label>
                    <input type="text" id="manualDesc" placeholder="Ex: Opera√ß√£o Tesouro Direto">
                </div>
                <div class="input-item">
                    <label for="manualBanco">Banco</label>
                    <input type="text" id="manualBanco" placeholder="Ex: BANCO DO BRASIL S.A.">
                </div>
                <div class="input-item" style="min-width: 120px;">
                    <label for="manualCedente">Conta Cedente</label>
                    <input type="text" id="manualCedente" placeholder="000.000">
                </div>
                <div class="input-item" style="min-width: 120px;">
                    <label for="manualCessionario">Conta Cession√°rio</label>
                    <input type="text" id="manualCessionario" placeholder="000.000">
                </div>
            </div>
            <div class="input-group">
                <div class="input-item" style="min-width: 150px;">
                    <label for="manualCompromissada">Valor Compromissada (R$)</label>
                    <input type="text" id="manualCompromissada" placeholder="1.000.000,00">
                </div>
                <div class="input-item" style="min-width: 150px;">
                    <label for="manualRetorno">Valor Retorno Bruto (R$)</label>
                    <input type="text" id="manualRetorno" placeholder="1.000.413,50">
                </div>
                 <div class="input-item" style="min-width: 100px;">
                    <label for="manualCdiTaxa">Taxa CDI (%) (Opcional)</label>
                    <input type="text" id="manualCdiTaxa" placeholder="14,90 (se for diferente do padr√£o)">
                </div>
            </div>
            <div class="btn-container">
                <button id="addBtn" class="btn">‚ûï Adicionar Lan√ßamento</button>
                <button id="cancelEditBtn" class="btn secondary" style="display: none;">‚ùå Cancelar Edi√ß√£o</button>
            </div>
        </div>

        <hr>

        <div class="filter-controls">
            <h2>üîç Filtros e Ferramentas</h2>
            <div class="input-group" style="align-items: flex-end;">
                <div class="input-item" style="min-width: 150px;">
                    <label for="filterStartDate">Data Inicial</label>
                    <input type="date" id="filterStartDate">
                </div>
                <div class="input-item" style="min-width: 150px;">
                    <label for="filterEndDate">Data Final</label>
                    <input type="date" id="filterEndDate">
                </div>
                <div class="input-item" style="flex-grow: 0;">
                    <label for="showIndividualOps">Mostrar Detalhe?</label>
                    <input type="checkbox" id="showIndividualOps" style="width: 20px; height: 20px; margin-top: 5px;">
                </div>
                <div class="input-item" style="flex-grow: 1;">
                    <button id="filterBtn" class="btn">üîé Aplicar Filtros</button>
                </div>
                <div class="input-item" style="flex-grow: 1;">
                    <button id="resetFilterBtn" class="btn secondary">üßπ Limpar Filtros</button>
                </div>
            </div>
            
            <div class="btn-container">
                <input type="file" id="excelFile" accept=".xlsx, .xls" multiple>
                <button id="loadExcelBtn" class="btn">üì• Importar Excel (.xlsx)</button>
                <button id="exportBtn" class="btn">üì§ Exportar Tabela (Excel)</button>
                <button id="printBtn" class="btn secondary">üñ®Ô∏è Imprimir Tabela</button>
                <button id="deleteAllBtn" class="btn danger">üí£ Excluir TODAS as Opera√ß√µes</button>
            </div>
        </div>
        
        <hr>

        <div class="table-section">
            <h2>üìä Resultados das Opera√ß√µes</h2>
            <div id="resultTable">
                </div>
        </div>
    </main>

<script>
    /* ---------- Inicializa√ß√£o Firebase e Vari√°veis Globais ---------- */
    const firebaseConfig = {
        apiKey: "AIzaSyD_vxw2VcSPO_tMXgrl7quZ855ODvpqQuR8",
        authDomain: "controle-cdi.firebaseapp.com",
        databaseURL: "https://controle-cdi-default-rtdb.firebaseio.com",
        projectId: "controle-cdi",
        storageBucket: "controle-cdi.firebasestorage.app",
        messagingSenderId: "215359645646",
        appId: "1:215359645646:web:cd61ae2f72e100d522ad9f",
        measurementId: "G-TV1M1QWQRC"
    };

    // CORRE√á√ÉO ESSENCIAL: Inicializa o Firebase e define 'db' no escopo global imediatamente.
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();
    const DOC_REF = db.collection("configuracao_global").doc("dados_cdi");
    let operacoes = [], totalCompromissada = 0, totalRetorno = 0, totalGanho = 0;

    /* ---------- Fun√ß√µes utilit√°rias e l√≥gica ---------- */
    function log(message) { document.getElementById('log').textContent = message; }

    const logoInput = document.getElementById('logoFile');
    const siteLogo = document.getElementById('siteLogo');

    // Fun√ß√µes de formata√ß√£o e limpeza
    function cleanCurrency(v) {
        if (typeof v !== 'string') v = String(v);
        let cleanString = v.replace(/[R$\s]/g, '');
        cleanString = cleanString.replace(/\./g, '');
        cleanString = cleanString.replace(/,/g, '.');
        const n = parseFloat(cleanString);
        return isNaN(n) ? 0 : n;
    }
    function parseNumber(v) {
        if (v === undefined || v === null || v === '') return 0;
        if (typeof v === 'string' && (v.includes(',') || v.includes('R$'))) return cleanCurrency(v);
        const n = parseFloat(v);
        return isNaN(n) ? 0 : n;
    }
    function cleanCdiTaxa(v) {
        if (v === undefined || v === null || v === '') return 0;
        if (typeof v !== 'string') v = String(v);
        v = v.replace(/[^0-9,.]/g, '');
        let c = v.replace(/,/g, '.'); // Troca todas as v√≠rgulas por ponto
        const n = parseFloat(c);
        return isNaN(n) ? 0 : n;
    }
    function formatBRL(n) { return n.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 2 }); }
    function formatPercent(n) { if (n === undefined || n === null || isNaN(n)) return ''; return n.toFixed(4).replace('.', ','); }
    function formatPU(n) { if (n === undefined || n === null || isNaN(n) || n === 0) return '-'; return n.toLocaleString('pt-BR', { minimumFractionDigits: 4, maximumFractionDigits: 4 }); }
    function formatDataBR(s) {
        if (!s) return '-';
        if (s.match(/^\d{4}-\d{2}-\d{2}$/)) {
            const [y, m, d] = s.split('-');
            return `${d}/${m}/${y}`;
        }
        if (s.match(/^\d{2}\/\d{2}\/\d{4}$/)) return s;
        const d = new Date(s);
        if (!isNaN(d)) return d.toLocaleDateString('pt-BR');
        return s;
    }
    function normalizeDate(s) {
        if (!s) return '';
        s = String(s).trim();
        if (s.match(/^\d{4}-\d{2}-\d{2}$/)) return s;
        if (s.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
            const [d, m, y] = s.split('/');
            return `${y}-${m}-${d}`;
        }
        const num = parseFloat(s);
        if (!isNaN(num) && num > 25569 && num < 70000) { // Excel serial date
            const base = new Date('1899-12-30');
            const date = new Date(base.getTime() + num * 24 * 60 * 60 * 1000);
            if (!isNaN(date)) {
                const y = date.getUTCFullYear();
                const m = date.getUTCMonth() + 1;
                const d = date.getUTCDate();
                const pad = n => n < 10 ? '0' + n : n;
                return `${y}-${pad(m)}-${pad(d)}`;
            }
        }
        try { const d = new Date(s); if (!isNaN(d)) return d.toISOString().split('T')[0]; } catch (e) { }
        return '';
    }

    // Fun√ß√£o de compress√£o de imagem (para o logo)
    async function compressImageFile(file, quality = 0.7, maxSize = 600) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ratio = Math.min(1, maxSize / Math.max(img.width, img.height));
                    canvas.width = Math.round(img.width * ratio);
                    canvas.height = Math.round(img.height * ratio);
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    try {
                        const dataUrl = canvas.toDataURL('image/jpeg', quality);
                        resolve(dataUrl);
                    } catch (err) { reject(err); }
                };
                img.onerror = reject;
                img.src = reader.result;
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    // Fun√ß√£o de reset de tema
    function resetThemeToFixed() {
        document.documentElement.style.setProperty('--primary', '#0A0A33');
        document.documentElement.style.setProperty('--primary-light', '#1A1A55');
        document.documentElement.style.setProperty('--secondary', '#C00000');
        document.documentElement.style.setProperty('--secondary-light', '#E00000');

        document.querySelectorAll('.btn:not(.secondary):not(.danger)').forEach(b => {
            b.style.background = 'var(--primary)';
            b.style.border = '1px solid white';
            b.style.color = 'white';
        });

        document.querySelectorAll('.btn.secondary').forEach(b => {
            b.style.background = 'var(--secondary)';
            b.style.border = '1px solid white';
            b.style.color = 'white';
        });

        document.querySelectorAll('.btn.danger').forEach(b => {
            b.style.background = getComputedStyle(document.documentElement).getPropertyValue('--secondary').trim();
            b.style.color = '#ffffff';
            b.style.border = '1px solid white';
        });
    }

    /* --- Persist√™ncia e Estado (FIREBASE FIRESTORE) --- */
    function saveState() {
        try {
            if (typeof db === 'undefined') {
                log('‚ùå Erro: Firebase Firestore (db) n√£o inicializado. Verifique as chaves.');
                return;
            }

            const state = {
                operacoes: operacoes,
                taxaCdiAnual: document.getElementById('taxaCdiAnual').value,
                diasAno: document.getElementById('diasAno').value
            };

            DOC_REF.set(state)
                .then(() => console.log('‚úÖ Dados salvos na nuvem (Firestore)!'))
                .catch(e => {
                    log('‚ùå Erro ao salvar no Firestore: ' + e.message);
                    console.error("Erro ao salvar:", e);
                });

        } catch (e) {
            console.warn(e);
            log('‚ùå Erro inesperado ao tentar salvar no Firestore.');
        }
    }

    window.loadState = () => {
        resetThemeToFixed();

        try {
            const savedLogo = localStorage.getItem('cdiLogo');
            if (savedLogo) {
                siteLogo.src = savedLogo;
                siteLogo.style.display = 'block';
                log('üíæ Logo carregado do salvamento local.');
            }
        } catch (err) { console.warn(err); }

        DOC_REF.get()
            .then(doc => {
                if (doc.exists) {
                    const st = doc.data();
                    operacoes = st.operacoes || [];
                    document.getElementById('taxaCdiAnual').value = st.taxaCdiAnual || '14,90';
                    document.getElementById('diasAno').value = st.diasAno || '252';
                    log(`üíæ ${operacoes.length} opera√ß√µes carregadas do Firestore.`);
                } else {
                    log('Aguardando... N√£o h√° dados salvos no Firestore.');
                }
            })
            .catch(e => {
                log('‚ùå Erro ao carregar dados do Firestore: ' + e.message);
                console.error("Erro ao carregar:", e);
            })
            .finally(() => {
                attachFilterListeners();
                calculateAndRender();
            });
    };

    /* --- Fun√ß√µes de Renderiza√ß√£o e C√°lculo --- */
    function updateTotalCards() {
        document.querySelector('#totalCompromissadaDisplay p').textContent = formatBRL(totalCompromissada);
        document.querySelector('#totalRetornoDisplay p').textContent = formatBRL(totalRetorno);
        document.querySelector('#totalCdiDisplay p').textContent = formatBRL(totalGanho);
    }

    function calculateAndRender() {
        totalCompromissada = 0; totalRetorno = 0; totalGanho = 0;
        const cdiGlobal = cleanCdiTaxa(document.getElementById('taxaCdiAnual').value);
        const diasAno = parseNumber(document.getElementById('diasAno').value) || 252;
        const showIndividual = document.getElementById('showIndividualOps').checked;

        const filterStartDateStr = document.getElementById('filterStartDate').value;
        const filterEndDateStr = document.getElementById('filterEndDate').value;
        const filterStart = filterStartDateStr ? normalizeDate(filterStartDateStr) : '';
        const filterEnd = filterEndDateStr ? normalizeDate(filterEndDateStr) : '';

        // Aplica filtros
        let ops = operacoes.filter(op => {
            const d = normalizeDate(op.data);
            if (!d) return false;
            if (filterStart && d < filterStart) return false;
            if (filterEnd && d > filterEnd) return false;
            return true;
        });
        // Ordena por data
        ops.sort((a, b) => normalizeDate(a.data).localeCompare(normalizeDate(b.data)));

        document.getElementById('taxaCdiAnual').value = formatPercent(cdiGlobal);
        document.getElementById('diasAno').value = diasAno;

        let html = "<table><thead><tr><th>Data</th><th>Descri√ß√£o/Resumo</th><th>Banco</th><th>Conta Cedente</th><th>Conta Cession√°rio</th><th>Compromissada</th><th>Retorno Bruto</th><th>PU IDA</th><th>PU VOLTA</th><th>Taxa CDI Anual (%)</th><th>Ganho (R$) Di√°rio</th><th class='action-cell'>A√ß√µes</th></tr></thead><tbody>";
        const resumo = {};

        ops.forEach((op, index) => {
            const d = normalizeDate(op.data);
            const comp = parseNumber(op.compromissada);
            const ret = parseNumber(op.retorno);

            // Calcula o ganho com invers√£o de sinal se for "RECOMPRA"
            const isRecompra = (typeof op.descricao === 'string' && op.descricao.toUpperCase().includes('RECOMPRA'));
            const ganho = (ret - comp) * (isRecompra ? -1 : 1);
            const taxaUsada = (cleanCdiTaxa(op.cdiTaxa) > 0 && cleanCdiTaxa(op.cdiTaxa) !== 100) ? cleanCdiTaxa(op.cdiTaxa) : cdiGlobal;

            // Totais gerais
            totalCompromissada += comp;
            totalRetorno += ret;
            totalGanho += ganho;

            // Resumo por Data
            if (!resumo[d]) resumo[d] = { data: d, totalCompromissada: 0, totalRetorno: 0, totalGanho: 0, primeiraTaxa: taxaUsada };
            resumo[d].totalCompromissada += comp;
            resumo[d].totalRetorno += ret;
            resumo[d].totalGanho += ganho;

            if (showIndividual) {
                const ganhoClass = ganho > 0 ? 'ganho' : (ganho < 0 ? 'perda' : '');
                html += `<tr class="individual-operation-row" data-original-index="${operacoes.indexOf(op)}">
                    <td class="col-data">${formatDataBR(op.data)}</td>
                    <td class="col-left" title="${op.descricao || '-'}">${(op.descricao || '-')}</td>
                    <td class="col-left" title="${op.banco || '-'}">${(op.banco || '-')}</td>
                    <td>${op.contaCedente || '-'}</td>
                    <td>${op.contaCessionario || '-'}</td>
                    <td>${formatBRL(comp)}</td>
                    <td>${formatBRL(ret)}</td>
                    <td>${formatPU(parseNumber(op.puIda))}</td>
                    <td>${formatPU(parseNumber(op.puVolta))}</td>
                    <td style="text-align:center;">${(Number(taxaUsada) || 0).toFixed(4).replace('.', ',')}</td>
                    <td class="${ganhoClass}">${formatBRL(ganho)}</td>
                    <td class="action-cell">
                        <button class="btn small edit-btn" data-action="edit" data-index="${operacoes.indexOf(op)}">Alterar</button>
                        <button class="btn small secondary delete-btn" data-action="delete" data-index="${operacoes.indexOf(op)}">Excluir</button>
                    </td>
                </tr>`;
            }
        });

        // Adiciona Linhas de Resumo Di√°rio (agrupadas)
        const datas = Object.keys(resumo).sort();
        datas.forEach(d => {
            const r = resumo[d];
            const ganhoDiarioClass = r.totalGanho > 0 ? 'ganho' : (r.totalGanho < 0 ? 'perda' : '');
            const taxa = (Number(r.primeiraTaxa) || 0).toFixed(4).replace('.', ',');

            // Se for exibido o detalhe, adiciona um separador/resumo. Se n√£o, apenas o resumo.
            if (showIndividual) {
                html += `<tr><td colspan="12" style="padding: 0; height: 5px;"></td></tr>`;
                html += `<tr style="background: rgba(10,10,51,0.08); font-weight: 700;">
                    <td class="col-data">${formatDataBR(d)}</td>
                    <td class="col-left">RESUMO DI√ÅRIO</td>
                    <td colspan="3">-</td>
                    <td>${formatBRL(r.totalCompromissada)}</td>
                    <td>${formatBRL(r.totalRetorno)}</td>
                    <td colspan="2">-</td>
                    <td style="text-align:center;">${taxa}</td>
                    <td class="${ganhoDiarioClass}">${formatBRL(r.totalGanho)}</td>
                    <td class="action-cell">-</td>
                </tr>`;
            } else {
                html += `<tr>
                    <td class="col-data">${formatDataBR(d)}</td>
                    <td class="col-left">RESUMO DI√ÅRIO</td>
                    <td colspan="3">-</td>
                    <td>${formatBRL(r.totalCompromissada)}</td>
                    <td>${formatBRL(r.totalRetorno)}</td>
                    <td colspan="2">-</td>
                    <td style="text-align:center;">${taxa}</td>
                    <td class="${ganhoDiarioClass}">${formatBRL(r.totalGanho)}</td>
                    <td class="action-cell">-</td>
                </tr>`;
            }
        });

        if (ops.length === 0) {
            html += `<tr><td colspan="12" style="text-align:center; padding: 20px;">Nenhuma opera√ß√£o encontrada para os filtros aplicados.</td></tr>`;
        }

        html += "</tbody></table>";
        document.getElementById('resultTable').innerHTML = html;
        updateTotalCards();
        log(`Tabela atualizada. ${ops.length} opera√ß√µes exibidas (filtradas).`);
    }

    // Fun√ß√£o para Limpar o Formul√°rio Manual
    function clearManualForm() {
        document.getElementById('manualData').value = '';
        document.getElementById('manualDesc').value = '';
        document.getElementById('manualBanco').value = '';
        document.getElementById('manualCedente').value = '';
        document.getElementById('manualCessionario').value = '';
        document.getElementById('manualCdiTaxa').value = '';
        document.getElementById('manualCompromissada').value = '';
        document.getElementById('manualRetorno').value = '';
        document.getElementById('editIndex').value = '-1';
        document.getElementById('addBtn').textContent = 'Adicionar Lan√ßamento';
        document.getElementById('cancelEditBtn').style.display = 'none';
        log('Formul√°rio manual limpo.');
    }

    // Fun√ß√£o para carregar dados para edi√ß√£o
    function loadForEdit(index) {
        const op = operacoes[index];
        if (!op) return log('‚ùå Erro: Opera√ß√£o n√£o encontrada para edi√ß√£o.');

        document.getElementById('manualData').value = normalizeDate(op.data);
        document.getElementById('manualDesc').value = op.descricao || '';
        document.getElementById('manualBanco').value = op.banco || '';
        document.getElementById('manualCedente').value = op.contaCedente || '';
        document.getElementById('manualCessionario').value = op.contaCessionario || '';
        document.getElementById('manualCdiTaxa').value = (op.cdiTaxa && op.cdiTaxa != document.getElementById('taxaCdiAnual').value) ? op.cdiTaxa : '';
        document.getElementById('manualCompromissada').value = parseNumber(op.compromissada).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
        document.getElementById('manualRetorno').value = parseNumber(op.retorno).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
        document.getElementById('editIndex').value = index;
        document.getElementById('addBtn').textContent = 'Salvar Edi√ß√£o';
        document.getElementById('cancelEditBtn').style.display = 'inline-flex';
        log(`‚úèÔ∏è Carregado dados da opera√ß√£o ${index} para edi√ß√£o.`);
    }

    /* --- Event Listeners e Fun√ß√µes de A√ß√£o --- */
    
    // Configura listeners para os bot√µes de filtro
    function attachFilterListeners() {
        document.getElementById('filterBtn').addEventListener('click', calculateAndRender);
        document.getElementById('resetFilterBtn').addEventListener('click', () => {
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            calculateAndRender();
        });
        document.getElementById('showIndividualOps').addEventListener('change', calculateAndRender);
    }
    
    // Adicionar/Editar Lan√ßamento Manual
    document.getElementById('addBtn').addEventListener('click', () => {
        const data = document.getElementById('manualData').value;
        const desc = document.getElementById('manualDesc').value;
        const banco = document.getElementById('manualBanco').value;
        const cedente = document.getElementById('manualCedente').value;
        const cessionario = document.getElementById('manualCessionario').value;
        const cdiTaxa = document.getElementById('manualCdiTaxa').value;
        const comp = document.getElementById('manualCompromissada').value;
        const ret = document.getElementById('manualRetorno').value;
        const editIndex = parseInt(document.getElementById('editIndex').value);

        if (!data || !comp || !ret) {
            alert('Por favor, preencha a Data, Valor Compromissada e Valor Retorno.');
            return;
        }

        const newOp = {
            data: data,
            descricao: desc,
            banco: banco,
            contaCedente: cedente,
            contaCessionario: cessionario,
            cdiTaxa: cdiTaxa,
            compromissada: comp,
            retorno: ret,
            puIda: 0, // Campos vazios para compatibilidade
            puVolta: 0
        };

        if (editIndex !== -1 && editIndex < operacoes.length) {
            operacoes[editIndex] = newOp;
            log(`‚úÖ Opera√ß√£o editada com sucesso na posi√ß√£o ${editIndex}.`);
        } else {
            operacoes.push(newOp);
            log('‚úÖ Novo lan√ßamento adicionado com sucesso!');
        }

        clearManualForm();
        calculateAndRender();
        saveState();
    });

    document.getElementById('cancelEditBtn').addEventListener('click', clearManualForm);

    // Delega√ß√£o de eventos para bot√µes na tabela (Editar e Excluir)
    document.getElementById('resultTable').addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;

        const action = btn.getAttribute('data-action');
        const index = parseInt(btn.getAttribute('data-index'));

        if (isNaN(index)) return;

        if (action === 'edit') {
            loadForEdit(index);
        } else if (action === 'delete') {
            if (confirm(`Tem certeza que deseja excluir a opera√ß√£o na linha ${index + 1}?`)) {
                operacoes.splice(index, 1);
                log(`üóëÔ∏è Opera√ß√£o na linha ${index + 1} exclu√≠da.`);
                calculateAndRender();
                saveState();
            }
        }
    });

    // A√ß√£o de Excluir Tudo
    document.getElementById('deleteAllBtn').addEventListener('click', () => {
        if (confirm('‚ö†Ô∏è ATEN√á√ÉO: Tem certeza que deseja excluir TODAS as opera√ß√µes salvas no sistema? Esta a√ß√£o √© irrevers√≠vel.')) {
            operacoes = [];
            log('üóëÔ∏è Todas as opera√ß√µes foram exclu√≠das.');
            calculateAndRender();
            saveState();
        }
    });

    // A√ß√£o de Exportar
    document.getElementById('exportBtn').addEventListener('click', () => {
        if (operacoes.length === 0) {
            log('N√£o h√° dados para exportar.');
            return;
        }
        const dataToExport = operacoes.map(op => ({
            Data: formatDataBR(op.data),
            Descri√ß√£o: op.descricao,
            Banco: op.banco,
            'Conta Cedente': op.contaCedente,
            'Conta Cession√°rio': op.contaCessionario,
            Compromissada: parseNumber(op.compromissada).toFixed(2),
            'Retorno Bruto': parseNumber(op.retorno).toFixed(2),
            'PU IDA': op.puIda,
            'PU VOLTA': op.puVolta,
            'Taxa CDI Anual (%)': op.cdiTaxa,
        }));

        const ws = XLSX.utils.json_to_sheet(dataToExport);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Dados CDI");
        XLSX.writeFile(wb, "Controle_Ganhos_CDI.xlsx");
        log('Exporta√ß√£o para Excel conclu√≠da.');
    });

    // A√ß√£o de Impress√£o
    document.getElementById('printBtn').addEventListener('click', () => {
        window.print();
    });

    // Configura√ß√£o de Logo
    if (logoInput) {
        logoInput.addEventListener('change', async (e) => {
            const file = e.target.files && e.target.files[0];
            if (!file) return;

            try {
                const compressed = await compressImageFile(file, 0.7, 600);
                siteLogo.src = compressed;
                siteLogo.style.display = 'block';
                localStorage.setItem('cdiLogo', compressed);
                log('‚úÖ Logo salvo localmente.');
            } catch (err) {
                console.error(err);
                log('‚ùå Erro ao processar o logo.');
            }
            resetThemeToFixed();
        });

        const addLogoBtn = document.getElementById('addLogoBtn');
        if (addLogoBtn) {
            addLogoBtn.addEventListener('click', () => {
                logoInput.click();
            });
        }
    }
    const removeLogoBtn = document.getElementById('removeLogoBtn');
    if (removeLogoBtn) {
        removeLogoBtn.addEventListener('click', () => {
            if (!confirm('Tem certeza que deseja remover logo salvo e restaurar padr√£o?')) return;
            localStorage.removeItem('cdiLogo');
            siteLogo.src = '';
            siteLogo.style.display = 'none';
            resetThemeToFixed();
            log('üóëÔ∏è Logo removido. Tema restaurado.');
        });
    }

    // Importa√ß√£o de Arquivos (Apenas esbo√ßo da l√≥gica, requer mapeamento de cabe√ßalhos)
    document.getElementById('loadExcelBtn').addEventListener('click', () => {
        const fileInput = document.getElementById('excelFile');
        const files = fileInput.files;

        if (files.length === 0) {
            alert('Por favor, selecione um ou mais arquivos para importar.');
            return;
        }

        log(`Iniciando importa√ß√£o de ${files.length} arquivo(s).`);

        const processFile = (file) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                const headers = json[0];
                const dataRows = json.slice(1);
                
                const newOperations = dataRows.map(row => {
                    // Mapeamento de exemplo (ajuste para seus headers reais)
                    const tempOp = {};
                    headers.forEach((header, i) => {
                        if (header && String(header).toLowerCase().includes('data')) tempOp.data = row[i];
                        if (header && String(header).toLowerCase().includes('descri')) tempOp.descricao = row[i];
                        if (header && String(header).toLowerCase().includes('banco')) tempOp.banco = row[i];
                        if (header && (String(header).toLowerCase().includes('taxa') || String(header).toLowerCase().includes('tx.'))) tempOp.cdiTaxa = row[i];
                        if (header && String(header).toLowerCase().includes('compromissada')) tempOp.compromissada = row[i];
                        if (header && String(header).toLowerCase().includes('retorno')) tempOp.retorno = row[i];
                        if (header && String(header).toLowerCase().includes('ida')) tempOp.puIda = row[i];
                        if (header && String(header).toLowerCase().includes('volta')) tempOp.puVolta = row[i];
                        if (header && String(header).toLowerCase().includes('cedente')) tempOp.contaCedente = row[i];
                        if (header && String(header).toLowerCase().includes('cessionario')) tempOp.contaCessionario = row[i];
                    });
                    
                    // Normaliza os dados
                    if(tempOp.data) tempOp.data = normalizeDate(tempOp.data);
                    
                    return tempOp;
                }).filter(op => op.data && op.compromissada && op.retorno); // Filtra linhas inv√°lidas

                operacoes.push(...newOperations);
                log(`‚úÖ Importado ${newOperations.length} opera√ß√µes do arquivo ${file.name}.`);
                calculateAndRender();
                saveState();
            };
            reader.readAsArrayBuffer(file);
        };

        Array.from(files).forEach(processFile);
        fileInput.value = ''; // Limpa a sele√ß√£o
    });


    // Inicia o carregamento de dados quando o DOM estiver pronto
    document.addEventListener('DOMContentLoaded', () => {
        window.loadState();
    });

</script>

</body>
</html>
